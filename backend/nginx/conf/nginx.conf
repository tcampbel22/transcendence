worker_processes auto;

events {
    worker_connections 1024;  # Maximum number of simultaneous connections
}

http {
    server_tokens off;
    ignore_invalid_headers on;
    limit_req_zone $binary_remote_addr zone=one:10m rate=25r/s;
	include /etc/nginx/mime.types;
    default_type application/octet-stream;

	log_format json_combined escape=json '{ "time_local": "$time_local", '
                        '"remote_addr": "$remote_addr", '
                        '"request": "$request", '
                        '"method": "$request_method", '
                        '"status": "$status", '
                        '"body_bytes_sent": "$body_bytes_sent", '
                        '"http_referer": "$http_referer", '
                        '"http_user_agent": "$http_user_agent", '
                        '"request_time": "$request_time" }';

	access_log /var/log/nginx/access.log json_combined;
	error_log /var/log/nginx/error.log debug;


    server {
        listen 80;
        server_name transendence.fly.dev;
        return 301 https://transendence.fly.dev;
    }

    server {
        listen 8080;
        server_name transendence.fly.dev;

        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";
		add_header Content-Security-Policy "default-src 'self'; base-uri 'self'; font-src 'self' https: data:; form-action 'self'; frame-ancestors 'self'; img-src 'self' data: blob:; object-src 'none'; script-src 'self'; script-src-attr 'none'; style-src 'self' https: 'unsafe-inline'; upgrade-insecure-requests; connect-src 'self' https://transendence.fly.dev http://tc-auth-service.internal:3003 https://accounts.google.com https://www.googleapis.com https://oauth2.googleapis.com;" always;
		add_header Referrer-Policy "no-referrer-when-cross-origin";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
		add_header Cross-Origin-Embedder-Policy "require-corp";
		add_header Cross-Origin-Resource-Policy "same-origin";
		add_header Cross-Origin-Opener-Policy "same-origin";
		add_header Permissions-Policy "geolocation=(), camera=(), microphone=(), fullscreen=(self)";


        client_max_body_size 10M;
        client_body_buffer_size 128k;

		location / {
			limit_req zone=one burst=50;
			root /frontend/dist;
			index index.html;
			try_files $uri /index.html;
		}
		
		# Game service
		# location /games/ {
		# resolver 8.8.8.8 [fdaa::3] valid=30s;
  		# 	proxy_pass http://tc-game-service.internal:3001/api/;
		# 	proxy_http_version 1.1;
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection 'upgrade';
        #     proxy_set_header Host $host;
        #     proxy_cache_bypass $http_upgrade;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        #     proxy_set_header X-Forwarded-Host $host;
        #     proxy_set_header X-Forwarded-Port $server_port;
        #     proxy_buffering on;
        #     proxy_buffers 16 4k;
        #     proxy_busy_buffers_size 8k;
        #     proxy_cache_lock on;
        #     proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
		# 	proxy_intercept_errors off;

		# }
		# User management service
		location /users/ {
			resolver 8.8.8.8 [fdaa::3] valid=30s;
  			
			proxy_pass http://tc-user-service.internal:3002/api/;
			
			proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_buffering on;
            proxy_buffers 16 4k;
            proxy_busy_buffers_size 8k;
            proxy_cache_lock on;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
			proxy_intercept_errors off;

		}
		# Authentication service
		# location /auth/ {
		# 	proxy_pass http://tc-auth-service.internal:3003;
		# 	proxy_http_version 1.1;
        #     proxy_set_header Upgrade $http_upgrade;
        #     proxy_set_header Connection 'upgrade';
        #     proxy_set_header Host $host;
        #     proxy_cache_bypass $http_upgrade;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        #     proxy_set_header X-Forwarded-Host $host;
        #     proxy_set_header X-Forwarded-Port $server_port;
        #     proxy_buffering on;
        #     proxy_buffers 16 4k;
        #     proxy_busy_buffers_size 8k;
        #     proxy_cache_lock on;
        #     proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

		# 	rewrite ^/auth/(google|verify-otp|send-email)$ /$1 break;
		# }

        # location = /callback.html {
        #     proxy_pass http://tc-auth-service.internal:3003/callback.html;
        #     proxy_set_header Host $host;
        # }

		# Block sensitive files
	    location ~ \.(htaccess|htpasswd|ini|phps|fla|psd|log|sh)$ {
	        deny all;
	    }

        # Block path
        location ~ \.\. {
            deny all;
        }

        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot|otf|ttc|mp4|webm|ogg|ogv|json|xml)$ {
        	root /frontend/dist;
			expires 30d;
       		add_header Cache-Control "public, immutable";
        }

		location /public/ {
			root /frontend/dist/;
			expires 30d;
       		add_header Cache-Control "public, immutable";
		}

    }
}
